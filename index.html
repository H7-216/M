<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé¨ StreamVision - Plateforme de Streaming Premium</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé¨</text></svg>">
    <style>
        /* [Vos styles CSS existants - inchang√©s] */
        :root {
            --primary: #6a11cb;
            --secondary: #2575fc;
            --accent: #00f2fe;
            --dark: #0f0c29;
            --light: #f8f9fa;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ff9800;
            --info: #2196f3;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--dark), var(--primary));
            color: var(--light);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* [Tous vos autres styles restent identiques] */
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- [Votre HTML existant - inchang√©] -->
    <header class="header">
        <h1>üé¨ StreamVision</h1>
        <p>Votre plateforme de streaming haute qualit√©</p>
        <div class="api-status" id="apiStatus">
            <span id="apiStatusIcon">‚è≥</span>
            <span id="apiStatusText">Connexion en cours...</span>
        </div>
    </header>

    <div class="search-container">
        <input type="text" class="search-box" placeholder="üîç Rechercher un film, s√©rie ou anim√©..." id="searchBox">
    </div>

    <div class="categories">
        <button class="category-btn active" onclick="filterContent('all')">
            <span>üéØ</span> Tout
        </button>
        <button class="category-btn" onclick="filterContent('movie')">
            <span>üé¨</span> Films
        </button>
        <button class="category-btn" onclick="filterContent('series')">
            <span>üì∫</span> S√©ries
        </button>
        <button class="category-btn" onclick="filterContent('anime')">
            <span>üéå</span> Anim√©s
        </button>
    </div>

    <div class="stats" id="stats">
        <div class="stat-item">
            <div class="stat-number" id="movieCount">0</div>
            <div class="stat-label">Films</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="seriesCount">0</div>
            <div class="stat-label">S√©ries</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="animeCount">0</div>
            <div class="stat-label">Anim√©s</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="totalCount">0</div>
            <div class="stat-label">Total</div>
        </div>
    </div>

    <div id="loadingIndicator" class="loading">
        <div class="spinner"></div>
        <div>Chargement du contenu...</div>
    </div>

    <div id="errorIndicator" class="error" style="display: none;">
        <div class="error-icon">‚ùå</div>
        <h3>Erreur de connexion</h3>
        <p id="errorMessage">Impossible de charger le contenu. Veuillez r√©essayer.</p>
    </div>

    <div class="content-grid" id="contentGrid">
        <!-- Contenu charg√© dynamiquement -->
    </div>

    <script>
        // Configuration initiale avec fallback
        const DEFAULT_API_CONFIG = {
            API_BASE_URL: 'https://98330cb9-d0c6-450d-a9ed-6f8c130b81f8-00-17uh62fvqj0wi.janeway.replit.dev',
            API_KEY: '55f7a2cc6ed112b9ed793081e5bbcd2e'
        };

        // R√©cup√©rer la config depuis localStorage ou utiliser les valeurs par d√©faut
        let apiConfig = JSON.parse(localStorage.getItem('streamvision_api_config')) || DEFAULT_API_CONFIG;
        
        // Variables globales
        let API_BASE_URL = apiConfig.API_BASE_URL;
        let API_KEY = apiConfig.API_KEY;
        let API_ENDPOINT = `${API_BASE_URL}/api/key/${API_KEY}`;
        
        let contentData = [];
        let currentFilter = 'all';
        
        // Fonction pour mettre √† jour la configuration API
        function updateApiConfig(newConfig) {
            API_BASE_URL = newConfig.API_BASE_URL;
            API_KEY = newConfig.API_KEY;
            API_ENDPOINT = `${API_BASE_URL}/api/key/${API_KEY}`;
            
            // Sauvegarder dans localStorage
            localStorage.setItem('streamvision_api_config', JSON.stringify(newConfig));
            
            console.log('üîë Configuration API mise √† jour :', newConfig);
        }

        // Fonction pour v√©rifier la connectivit√© API
        async function checkApiConnectivity() {
            try {
                const response = await fetch(API_ENDPOINT, {
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    }
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        // Fonctions utilitaires (inchang√©es)
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'flex' : 'none';
        }

        function showError(show, message = '') {
            const errorEl = document.getElementById('errorIndicator');
            if (show) {
                errorEl.style.display = 'block';
                if (message) document.getElementById('errorMessage').textContent = message;
            } else {
                errorEl.style.display = 'none';
            }
        }

        function updateApiStatus(connected, message = '') {
            const statusEl = document.getElementById('apiStatus');
            const iconEl = document.getElementById('apiStatusIcon');
            const textEl = document.getElementById('apiStatusText');
            
            if (connected) {
                iconEl.textContent = 'üîê';
                textEl.textContent = message || 'API Connect√©e';
                statusEl.style.background = 'rgba(76, 175, 80, 0.15)';
                statusEl.style.color = 'var(--success)';
            } else {
                iconEl.textContent = '‚ö†Ô∏è';
                textEl.textContent = message || 'API D√©connect√©e';
                statusEl.style.background = 'rgba(244, 67, 54, 0.15)';
                statusEl.style.color = 'var(--danger)';
            }
        }

        // Chargement du contenu depuis l'API
        async function loadContent() {
            showLoading(true);
            showError(false);
            updateApiStatus(false, 'Connexion √† l\'API...');

            try {
                console.log(`üåê Tentative de connexion √†: ${API_ENDPOINT}`);
                
                // V√©rifier d'abord la connectivit√©
                const isApiConnected = await checkApiConnectivity();
                
                if (!isApiConnected) {
                    // Essayer de r√©cup√©rer la derni√®re config valide
                    const lastWorkingConfig = JSON.parse(localStorage.getItem('streamvision_last_working_config'));
                    if (lastWorkingConfig) {
                        updateApiConfig(lastWorkingConfig);
                        console.log('üîÑ Retour √† la derni√®re configuration fonctionnelle');
                    }
                    
                    throw new Error('Impossible de se connecter √† l\'API');
                }

                const response = await fetch(API_ENDPOINT, {
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                contentData = data.content || [];
                
                console.log(`‚úÖ ${contentData.length} contenus charg√©s depuis l'API`);
                updateApiStatus(true, `Connect√© - ${contentData.length} contenus`);
                
                // Sauvegarder cette config comme fonctionnelle
                localStorage.setItem('streamvision_last_working_config', JSON.stringify({
                    API_BASE_URL: API_BASE_URL,
                    API_KEY: API_KEY
                }));
                
                displayContent(contentData);
                updateStatsFromData();

            } catch (error) {
                console.error('‚ùå Erreur lors du chargement:', error);
                updateApiStatus(false, 'Erreur de connexion');
                showError(true, error.message);
                
                // Mode d√©mo avec contenu factice
                contentData = getDemoContent();
                displayContent(contentData);
                updateStatsFromData();
            } finally {
                showLoading(false);
            }
        }

        // [Les autres fonctions restent identiques : getDemoContent, updateStatsFromData, 
        // displayContent, getCategoryLabel, filterContent, etc.]

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initialisation de StreamVision');
            console.log('üîë Configuration API:', { API_BASE_URL, API_KEY });
            
            // V√©rifier si nous avons une nouvelle config dans l'URL (ex: ?api_url=...&api_key=...)
            const urlParams = new URLSearchParams(window.location.search);
            const newApiUrl = urlParams.get('api_url');
            const newApiKey = urlParams.get('api_key');
            
            if (newApiUrl && newApiKey) {
                updateApiConfig({
                    API_BASE_URL: newApiUrl,
                    API_KEY: newApiKey
                });
            }
            
            loadContent();

            // Actualisation p√©riodique
            setInterval(() => {
                console.log('üîÑ Actualisation automatique du contenu...');
                loadContent();
            }, 300000); // Toutes les 5 minutes
        });

        /* [Toutes vos autres fonctions existantes restent inchang√©es] */
        function getDemoContent() {
            return [
                {
                    id: 1,
                    title: "Exemple de Film",
                    category: "movie",
                    image: "https://via.placeholder.com/800x450?text=Exemple+Film",
                    url: "https://www.youtube.com/embed/dQw4w9WgXcQ",
                    server_name: "Demo"
                },
                {
                    id: 2,
                    title: "Exemple de S√©rie",
                    category: "series",
                    image: "https://via.placeholder.com/800x450?text=Exemple+S√©rie",
                    url: "https://www.youtube.com/embed/dQw4w9WgXcQ",
                    server_name: "Demo"
                }
            ];
        }

        function updateStatsFromData() {
            const stats = {
                movie: contentData.filter(item => item.category === 'movie').length,
                series: contentData.filter(item => item.category === 'series').length,
                anime: contentData.filter(item => item.category === 'anime').length,
                total: contentData.length
            };

            document.getElementById('movieCount').textContent = stats.movie;
            document.getElementById('seriesCount').textContent = stats.series;
            document.getElementById('animeCount').textContent = stats.anime;
            document.getElementById('totalCount').textContent = stats.total;
        }

        function displayContent(content) {
            const grid = document.getElementById('contentGrid');

            if (!content || content.length === 0) {
                grid.innerHTML = '<div class="no-content">üòî Aucun contenu disponible</div>';
                return;
            }

            grid.innerHTML = '';

            content.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'content-card';
                card.style.animationDelay = `${index * 0.1}s`;
                
                card.innerHTML = `
                    <div class="video-container">
                        <iframe src="${item.url}" 
                                title="${item.title}" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen
                                loading="lazy">
                        </iframe>
                    </div>
                    <div class="content-info">
                        <h3 class="content-title">${item.title}</h3>
                        <div class="content-meta">
                            <span class="content-category">${getCategoryLabel(item.category)}</span>
                            ${item.server_name ? `<span class="content-server">${item.server_name}</span>` : ''}
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function getCategoryLabel(category) {
            const labels = {
                'movie': 'üé¨ Film',
                'series': 'üì∫ S√©rie',
                'anime': 'üéå Anim√©'
            };
            return labels[category] || category;
        }

        function filterContent(category) {
            // Mettre √† jour les boutons actifs
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            currentFilter = category;

            // Filtrer le contenu
            let filtered = contentData;
            if (category !== 'all') {
                filtered = contentData.filter(item => item.category === category);
            }

            displayContent(filtered);
        }

        // Recherche en temps r√©el
        let searchTimeout;
        document.getElementById('searchBox').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = e.target.value.toLowerCase().trim();

                if (query === '') {
                    filterContent(currentFilter);
                    return;
                }

                const filtered = contentData.filter(item => 
                    item.title.toLowerCase().includes(query) ||
                    (item.server_name && item.server_name.toLowerCase().includes(query))
                );

                displayContent(filtered);
            }, 300);
        });
    </script>
</body>
</html>